# Epic 3 & 4 Retrospective

**Date:** 2026-01-14
**Epics:** Citation Verification Engine (Epic 3) & Timeline Construction Engine (Epic 4)
**Facilitator:** Bob (Scrum Master Agent)
**Participant:** Juhi

---

## Executive Summary

Epic 3 (Citation Verification Engine) and Epic 4 (Timeline Construction Engine) have been successfully completed. Both epics followed a consistent 4-stage pipeline architecture and achieved their core objectives of enabling attorneys to verify legal citations and construct annotated timelines from case documents.

| Metric | Epic 3 | Epic 4 | Combined |
|--------|--------|--------|----------|
| Stories Completed | 4/4 | 4/4 | 8/8 |
| Stories Pending Manual Tests | 1 (3-1) | 0 | 1 |
| Code Review Cycles | All passed | All passed | - |
| Test Coverage | 298+ tests | 68+ tests | 366+ tests |

---

## Epic 3: Citation Verification Engine

### Stories Delivered

| Story | Title | Status | Key Deliverable |
|-------|-------|--------|-----------------|
| 3-1 | Act Citation Extraction | review | Gemini-based extraction of Act names, section numbers, and citation text from case files |
| 3-2 | Act Discovery Report UI | done | Frontend UI showing citation coverage, missing Acts, and upload functionality |
| 3-3 | Citation Verification | done | Semantic verification of quoted text against actual Act sections using Gemini |
| 3-4 | Split-View Citation Highlighting | done | Side-by-side PDF viewer with canvas-based bounding box overlays |

### Technical Achievements

1. **PDF.js Integration with Canvas Overlays**
   - Implemented canvas-based bounding box rendering (not DOM elements) per performance requirements
   - Color-coded highlights: yellow (source), blue (verified), red (mismatch), orange (section not found)
   - Supports zoom, pan, and page navigation in both panels

2. **Zustand Store Pattern**
   - Split view state management following selector pattern per `project-context.md`
   - Keyboard shortcuts: Escape (close), F (fullscreen), arrows (prev/next citation)

3. **Full-Stack Citation Pipeline**
   ```
   EXTRACTION (3-1) → DISCOVERY (3-2) → VERIFICATION (3-3) → VISUALIZATION (3-4)
   ```

### Files Created (Epic 3)

**Frontend (Story 3-4):**
- `frontend/src/components/features/citation/SplitViewCitationPanel.tsx`
- `frontend/src/components/features/citation/SplitViewHeader.tsx`
- `frontend/src/components/features/citation/SplitViewModal.tsx`
- `frontend/src/components/features/citation/MismatchExplanation.tsx`
- `frontend/src/components/features/citation/CitationsList.tsx`
- `frontend/src/components/features/citation/CitationsTab.tsx`
- `frontend/src/components/features/pdf/PdfViewerPanel.tsx`
- `frontend/src/components/features/pdf/BboxOverlay.tsx`
- `frontend/src/lib/pdf/highlightUtils.ts`
- `frontend/src/stores/splitViewStore.ts`
- `frontend/src/hooks/useSplitView.ts`
- `frontend/src/types/pdf.ts`

**Backend (Story 3-4):**
- `backend/app/api/routes/citations.py` (split-view endpoint added)
- `backend/tests/api/test_citations_split_view.py`

---

## Epic 4: Timeline Construction Engine

### Stories Delivered

| Story | Title | Status | Key Deliverable |
|-------|-------|--------|-----------------|
| 4-1 | Date Extraction with Gemini | done | Extracts dates in various Indian formats with 200-word context windows |
| 4-2 | Event Classification | review-passed | Classifies events into 8 types (filing, notice, hearing, order, etc.) |
| 4-3 | Entity Linking & Timeline Construction | dev-complete | Links events to MIG entities, builds timeline with caching |
| 4-4 | Timeline Anomaly Detection | dev-complete | Rule-based detection of sequence violations, gaps, duplicates, outliers |

### Technical Achievements

1. **Complete Timeline Engine Pipeline**
   ```
   EXTRACTION (4-1) → CLASSIFICATION (4-2) → ENTITY LINKING (4-3) → ANOMALY DETECTION (4-4)
   ```

2. **Indian Legal Context Handling**
   - Date formats: DD/MM/YYYY, DD-MM-YYYY, DD.MM.YYYY, "dated X of Y", legal format "this X day of Y, 20XX"
   - SARFAESI legal sequences: TRANSACTION → NOTICE → FILING → HEARING → ORDER
   - Indian terminology: vakalatnama, rejoinder, Lok Adalat, SARFAESI, Section 138

3. **Rule-Based Anomaly Detection (Not LLM)**
   - Sequence violations: Events out of expected legal workflow order
   - Gap detection: Unusual time gaps (e.g., >180 days between notice and filing)
   - Duplicate detection: Similar events on same date
   - Outlier detection: Dates far outside case timeline

4. **MIG Integration**
   - Entity linking using existing `EntityResolver` for fuzzy name matching
   - Confidence threshold: 0.7 for automatic linking
   - Timeline cache in matter_memory for fast retrieval

### Files Created (Epic 4)

**Backend - Timeline Engine:**
- `backend/app/engines/timeline/__init__.py`
- `backend/app/engines/timeline/date_extractor.py`
- `backend/app/engines/timeline/event_classifier.py`
- `backend/app/engines/timeline/entity_linker.py`
- `backend/app/engines/timeline/timeline_builder.py`
- `backend/app/engines/timeline/anomaly_detector.py`
- `backend/app/engines/timeline/legal_sequences.py`
- `backend/app/engines/timeline/prompts.py`
- `backend/app/engines/timeline/classification_prompts.py`

**Backend - Models & Services:**
- `backend/app/models/timeline.py`
- `backend/app/models/anomaly.py`
- `backend/app/services/timeline_service.py`
- `backend/app/services/timeline_cache.py`
- `backend/app/services/anomaly_service.py`

**Backend - API Routes:**
- `backend/app/api/routes/timeline.py`
- `backend/app/api/routes/anomalies.py`

**Database:**
- `supabase/migrations/20260114000003_create_anomalies_table.sql`

**Tests:**
- `backend/tests/engines/timeline/test_date_extractor.py`
- `backend/tests/engines/timeline/test_event_classifier.py`
- `backend/tests/engines/timeline/test_entity_linker.py`
- `backend/tests/engines/timeline/test_timeline_builder.py`
- `backend/tests/engines/timeline/test_anomaly_detector.py`
- `backend/tests/services/test_timeline_service.py`
- `backend/tests/services/test_timeline_cache.py`
- `backend/tests/services/test_anomaly_service.py`
- `backend/tests/api/routes/test_timeline.py`
- `backend/tests/api/routes/test_anomalies.py`
- `backend/tests/integration/test_classification_pipeline.py`
- `backend/tests/integration/test_entity_linking_pipeline.py`
- `backend/tests/integration/test_anomaly_detection_pipeline.py`

---

## What Went Well

### 1. Pipeline Architecture Consistency
Both epics followed a consistent 4-stage pipeline pattern, making implementation predictable and code reviewable. Each stage has clear inputs/outputs and can be tested independently.

### 2. LLM Cost Optimization
Both epics correctly used **Gemini 1.5 Flash** for ingestion tasks instead of GPT-4, following the project's LLM routing rules:
- Date extraction: Gemini Flash (not GPT-4, would be 30x more expensive)
- Event classification: Gemini Flash
- Citation verification: Gemini Flash
- Anomaly detection: Rule-based (no LLM at all)

### 3. Effective Code Review Process
Every story had dedicated code review fix commits, demonstrating the review process is working:
- `fix(review): address code review issues for Story 3-4`
- `fix(review): address code review issues for Story 4-2`
- `fix(review): address code review issues for Story 4-3`
- `fix(review): address code review issues for Story 4-4`

### 4. Strong Test Coverage
- Epic 3, Story 3-4: 294 frontend tests + 4 backend tests
- Epic 4, Story 4-4: 68 tests (31 unit, 10 service, 19 API, 8 integration)
- Total across both epics: 366+ automated tests

### 5. Performance Requirements Adherence
Story 3-4 correctly implemented canvas-based bbox overlays instead of DOM elements, per `project-context.md` performance gotchas. This prevents performance issues when displaying 500+ bounding boxes.

### 6. Reuse of Existing Components
- Epic 4 reused `EntityResolver` from MIG for name matching
- Both epics followed existing service patterns from Epic 2
- Job tracking integration reused across all stories

---

## What Could Be Improved

### 1. Pipeline Integration Deferred
In Story 4-4, automatic triggering of anomaly detection after entity linking was deferred:
> *"Pipeline integration (auto-trigger after entity linking) deferred - requires orchestration work"*

The full pipeline still requires manual API calls between stages.

**Recommendation:** Consider implementing a simple orchestration layer or using Celery chains for Epic 5+.

### 2. Manual Tests Pending
Story 3-1 (Act Citation Extraction) has been in `review` status with manual tests pending, blocking the epic from being marked fully complete.

**Recommendation:** Create a checklist of manual test scenarios and schedule dedicated testing sessions.

### 3. Story Status Updates
Story 4-3 still has unchecked task boxes (`- [ ]`) despite being `dev-complete`. Task completion markers weren't consistently updated.

**Recommendation:** Update task checkboxes immediately upon completion, before marking story as complete.

### 4. Sprint Status Propagation
Epic statuses in sprint-status.yaml aren't automatically updated when all stories are complete.

**Recommendation:** Add a sprint-status sync step to the code review workflow.

---

## Lessons Learned

### 1. Defer Orchestration Complexity
Simple manual triggers work fine for MVP. Full automation between pipeline stages can come in later iterations.

### 2. Canvas Overlays Are Essential
DOM-based bbox rendering would have caused severe performance issues with 500+ highlights. The canvas approach was the right call.

### 3. Rule-Based Detection Over LLM
Anomaly detection uses deterministic rules, not Gemini, saving significant cost and improving reliability. LLM should only be used when rules are insufficient.

### 4. Indian Legal Context Matters
Indian date formats (DD/MM/YYYY), legal terminology (SARFAESI, vakalatnama), and statutory sequences required explicit handling. This domain knowledge was essential for accuracy.

### 5. Existing Components Save Time
Reusing `EntityResolver`, job tracking patterns, and service architectures from Epic 2 significantly accelerated development.

---

## Impact on Next Epic

### Epic 5: Contradiction Engine (Recommended Next)

The completed Timeline and Citation engines provide foundation for contradiction detection:

1. **Timeline Events** can be compared for temporal contradictions (e.g., "Document A says payment on Jan 1, Document B says payment on Feb 1")

2. **Entity-Linked Events** enable person-specific contradiction detection (e.g., "Entity X's statements conflict")

3. **Anomaly Detection Infrastructure** can be extended for contradiction severity scoring

### Suggested Approach
- Reuse the pipeline pattern: Extraction → Classification → Detection → Resolution
- Reuse anomaly service patterns for contradiction storage
- Consider rule-based detection first, LLM only for semantic contradictions

---

## Action Items

| Action | Owner | Priority |
|--------|-------|----------|
| Complete manual tests for Story 3-1 | Juhi | High |
| Update sprint-status.yaml to mark epics complete | Dev Agent | High |
| Update Story 4-3 task checkboxes | Dev Agent | Low |
| Document pipeline orchestration requirements for Epic 5 | Architect | Medium |

---

## Retrospective Sign-Off

**Scrum Master:** Bob (Agent)
**Date:** 2026-01-14
**Next Retrospective:** After Epic 5 completion

---

*Generated by BMAD Retrospective Workflow*
